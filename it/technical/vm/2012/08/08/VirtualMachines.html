
<!DOCTYPE html>
<html lang="cn" xmlns:wb="http://open.weibo.com/wb">
  <head>
    <meta charset="utf-8">
    <title>Virtual Machines</title>
    
    <meta name="author" content="王鹏程(WPC)">

    <!-- sina weibo API -->
    <meta property="wb:webmaster" content="632e6945a16c1527" />
<!--必填-->
<meta property="og:type" content="article" />
<meta property="og:url" content="/it/technical/vm/2012/08/08/VirtualMachines" />
<meta property="og:title" content="Virtual Machines" />
<meta property="og:description" content=" " />
<!--选填-->
<meta name="weibo:article:create_at" content="2012-08-08" />

<meta name="weibo:article:update_at" content="2013-05-04" />

<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>

    <!-- sina weibo API END -->

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes//bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes//css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes//toc/css/toc.css" rel="stylesheet" type="text/css" media="screen">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">PC的程序员记录</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">所有文章</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">目录分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/search">站内检索</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签云</a></li>
      	
      
    
  




          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        
<div class="page-header">
    <h1>
        Virtual Machines
        <small>
            
            2016 程序"猿"码代中
            
        </small>
    </h1>
    <wb:share-button appkey="2546085774" addition="number" type="button" ralateUid="1620259387" pic="http%3A%2F%2Fpic.yupoo.com%2Fqianjigui%2FDuruKAwV%2FyhZb1.jpg"></wb:share-button>

</div>

<div class="row">
  <div class="span8" id='main_content'>
    <h1 id="tocAnchor-1-1">Virtual Machines</h1>

<h2 id="tocAnchor-1-1-1">导论</h2>

<ul>
<li>计算机体系结构

<ul>
<li>概念

<ul>
<li>ISA(Instruction Set Architecture)指令集体系结构

<ul>
<li>user ISA</li>
<li>system ISA</li>
</ul>
</li>
<li>ABI(Application Binary Interface)应用二进制接口</li>
<li>API(Application Program Interface)应用编程接口</li>
</ul>
</li>
<li><img src="http://pic.yupoo.com/qianjigui/CaVbCW9i/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVbCW9i/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CaVcUY2N/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVcUY2N/medish.jpg" /></li>
</ul>
</li>
<li>VM-base

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CaVbEzly/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVbEzly/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CaVbHPeS/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVbHPeS/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CaVbMx2U/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVbMx2U/medish.jpg" /></li>
</ul>
</li>
<li>进程VM

<ul>
<li>多进程支持级别</li>
<li>仿真器和动态二进制翻译器

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CaVbFSZm/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVbFSZm/medish.jpg" /></li>
</ul>
</li>
<li>相同ISA下的二进制优化器</li>
<li>HLL-VM

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CaVbE2FD/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVbE2FD/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>系统VM

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CaVbIPjz/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVbIPjz/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CaVbBtBs/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVbBtBs/medish.jpg" /></li>
</ul>
</li>
<li>分类

<ul>
<li>进程VM

<ul>
<li>相同ISA

<ul>
<li>多进程</li>
<li>动态二进制优化器</li>
</ul>
</li>
<li>不同ISA

<ul>
<li>动态翻译器</li>
<li>高级语言虚拟机</li>
</ul>
</li>
</ul>
</li>
<li>系统VM

<ul>
<li>相同ISA

<ul>
<li>标准系统虚拟机</li>
<li>主机虚拟机</li>
</ul>
</li>
<li>不同ISA

<ul>
<li>全系统虚拟机</li>
<li>协同设计虚拟机</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<h2 id="tocAnchor-1-1-2">仿真：解释和二进制翻译</h2>

<ul>
<li>基本的解释器

<ul>
<li>译码分派解释器</li>
<li>switch-case:instruction</li>
<li>loop:codes</li>
<li>上下文环境:Context</li>
<li>问题

<ul>
<li>存在大量直接或间接的跳转</li>
<li>对cache不友好</li>
</ul>
</li>
</ul>
</li>
<li>线索解释

<ul>
<li>利用分派表来查找下一条指令解释例程</li>
<li>分派表

<ul>
<li>间接线索解释</li>
<li>dispatch-table</li>
</ul>
</li>
</ul>
</li>
<li>预先处理

<ul>
<li>预先译码</li>
<li>直接线索解释

<ul>
<li>通过预先译码，将操作码与具体例程做函数对应</li>
<li>直接例程地址</li>
<li>一次偏移内存地址</li>
</ul>
</li>
</ul>
</li>
<li>处理复杂指令集

<ul>
<li>不可能将每个例程都线索化</li>
<li>多个指令可能就是参数量不同，大量处理逻辑一致</li>
<li>多次分派与共享例程处理

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CaVDjup9/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVDjup9/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CaVDjpvO/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVDjpvO/medish.jpg" /></li>
</ul>
</li>
<li>通过软件流水的方式来组织分派循环的关键点是：与将来的源指令相关的加载操作与当前指令的解释相互重叠</li>
</ul>
</li>
<li>二进制翻译

<ul>
<li>直接将源程序翻译成平台相关的二进制码</li>
<li>状态隐射

<ul>
<li>指令操作</li>
<li>寄存器使用</li>
<li>存储器结构</li>
<li>虚拟机状态维护</li>
</ul>
</li>
</ul>
</li>
<li>代码发现和动态翻译

<ul>
<li>存在的问题(即代码发现问题)是如何准确定位需要执行的代码序列

<ul>
<li>无法将全部源码做二进制翻译</li>
</ul>
</li>
<li>如何定位间接跳转到源码位置(代码定位问题）</li>
<li>增量式预译码和翻译

<ul>
<li>通过一个仿真管理器来处理源ISA和目标ISA对应链接问题</li>
<li>一次只对一个动态block做二进制翻译</li>
<li>这些block被管理</li>
<li>通过管理器将执行流串起来</li>
</ul>
</li>
<li>存在的问题

<ul>
<li>自修改代码</li>
<li>自引用代码</li>
<li>异常处理</li>
</ul>
</li>
</ul>
</li>
<li>控制转移优化

<ul>
<li>翻译链接

<ul>
<li>通过仿真管理器将动态block链接起来</li>
</ul>
</li>
<li>软件间接跳转预测

<ul>
<li>内联高速缓存(inline caching)</li>
</ul>
</li>
<li>影子栈

<ul>
<li>在翻译时发生从翻译代码到目标二进制代码间接跳转时，需要纪录源程序的PC值（SPC），然后调用结束后通过SPC计算源程序的地址。这样存在一次查表</li>
<li>将源程序翻译时，发生调用时候的地址纪录放入影子栈中。在目标二进制代码调用返回时，目标二进制有个结果PC值（DPC），如果状态正常，则这个DPC可以直接被使用（上次动态二进制翻译时，这个DPC可能是个陷阱值：需要再次解析，也可能已经链接完成）</li>
<li><img src="http://pic.yupoo.com/qianjigui/CaVDjvhm/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CaVDjvhm/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
</ul>


<h2 id="tocAnchor-1-1-3">进程虚拟机</h2>

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CbHVlKve/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CbHVlKve/medish.jpg" /></li>
<li>兼容性

<ul>
<li>概念

<ul>
<li>内在兼容性

<ul>
<li>系统透明</li>
<li>完全满足各种需求</li>
</ul>
</li>
<li>外在兼容性

<ul>
<li>满足部分兼容性</li>
<li>依赖于具体实现和目标系统的特性</li>
</ul>
</li>
<li>源主机(被仿真设备)</li>
<li>目标机(虚拟机运行的硬件平台)</li>
</ul>
</li>
<li>框架

<ul>
<li>状态映射</li>
<li>方法

<ul>
<li>软件映射控制

<ul>
<li>内存

<ul>
<li>权限控制</li>
<li>粒度</li>
</ul>
</li>
<li>指令集合</li>
</ul>
</li>
<li>直接映射

<ul>
<li>目标机提供支持是源主机需求的超集</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>虚拟机实现与目标机(实际主机)有依赖</li>
</ul>
</li>
<li>状态映射

<ul>
<li>上下文环境

<ul>
<li>寄存器

<ul>
<li>完全映射

<ul>
<li>目标机寄存器可以涵盖虚拟机需求和源机器需求</li>
</ul>
</li>
<li>部分映射

<ul>
<li>部分存在目标机寄存器</li>
<li>部分存在于目标机内存</li>
</ul>
</li>
</ul>
</li>
<li>内存地址空间

<ul>
<li>软件转换表

<ul>
<li>类似于虚拟内存管理技术</li>
</ul>
</li>
<li>直接映射硬件区域

<ul>
<li>直接偏移</li>
<li>存在结构上的兼容性考虑</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>内存结构仿真

<ul>
<li>考虑的方面

<ul>
<li>内存空间的整体结构

<ul>
<li>分段</li>
<li>整体单调线性结构</li>
</ul>
</li>
<li>所支持的访问空间的权限类型

<ul>
<li>读</li>
<li>写</li>
<li>执行</li>
</ul>
</li>
<li>保护/分配粒度

<ul>
<li>有些是4k一页</li>
<li>有些可能是2的幂次</li>
</ul>
</li>
</ul>
</li>
<li>具体的问题

<ul>
<li>内存保护(权限控制映射)

<ul>
<li>借助于目标机的权限控制</li>
<li>通过软件映射表控制

<ul>
<li>目标机支持是源主机的子集</li>
<li>效率较低</li>
</ul>
</li>
<li>页大小问题(粒度映射)

<ul>
<li>数据和代码各自页对齐</li>
</ul>
</li>
</ul>
</li>
<li>自引用和自修改代码

<ul>
<li>基本方法:写保护、陷阱中断、软件控制</li>
<li>伪自修改代码(可写的数据区和代码混杂在一起的情况)

<ul>
<li>被保护代码和数据在一个页</li>
<li>方法

<ul>
<li>动态检查

<ul>
<li>代码区开启写保护</li>
<li>发生自修改</li>
<li>复制源码作为比较依据</li>
<li>插入检查逻辑</li>
<li>永远关闭该页的写保护</li>
</ul>
</li>
<li>将上述方法的检查逻辑作为独立块，进行链接</li>
</ul>
</li>
</ul>
</li>
<li>细粒度写保护

<ul>
<li>更细级别程度上设置标记</li>
</ul>
</li>
<li>可靠的自修改代码

<ul>
<li>利用固有的习惯用语进行操作</li>
<li>识别这些习惯用语</li>
</ul>
</li>
<li>保护运行时软件的内存

<ul>
<li>保证虚拟机不修改源主机的程序</li>
<li>进行软件检查

<ul>
<li>类似于高级语言的NULL-CHECK等

<ul>
<li>通过控制流、数据流分析优化掉部分检查</li>
</ul>
</li>
<li>只在解释器阶段检查，翻译后不做处理</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>指令仿真

<ul>
<li>权衡性能付出

<ul>
<li>解释器</li>
<li>翻译器</li>
</ul>
</li>
<li>分阶段指令仿真

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CbHVjx12/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CbHVjx12/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CbHVkIq0/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CbHVkIq0/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>异常处理

<ul>
<li>例外仿真

<ul>
<li>ABI可见

<ul>
<li>例如段错误</li>
<li>例外检查

<ul>
<li>利用目标机基础设施

<ul>
<li>源主机可见

<ul>
<li>直接映射</li>
</ul>
</li>
<li>源主机不可见

<ul>
<li>虚拟机封装掉</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ABI不可见

<ul>
<li>例如Java的OutOfArrayIndex</li>
<li>添加指令做检查</li>
</ul>
</li>
</ul>
</li>
<li>中断处理

<ul>
<li>处于解释器

<ul>
<li>直接处理</li>
</ul>
</li>
<li>处于翻译块阶段

<ul>
<li>快速反馈</li>
<li>尽量减少到可中断点时间</li>
</ul>
</li>
</ul>
</li>
<li>确定精确的客户机状态

<ul>
<li>便于调试</li>
<li>翻译时

<ul>
<li>即刻反馈</li>
</ul>
</li>
<li>二进制状态时

<ul>
<li>维护反向索引链表</li>
<li>从识别包含陷阱源指令的翻译块开始，然后将控制返回给运行时软件，运行时软件通过分析上下文给出正确的源状态和PC值</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>操作系统的仿真

<ul>
<li>系统调用映射问题</li>
<li>相同系统

<ul>
<li>一般可以直接映射调用</li>
<li>部分还是需要修改源程序的调用逻辑，进行修补调用</li>
</ul>
</li>
<li>不同系统

<ul>
<li>尽量保证逻辑上的正确性</li>
</ul>
</li>
</ul>
</li>
<li>代码Cache管理

<ul>
<li>结构

<ul>
<li>Hash映射</li>
<li>有限内存

<ul>
<li>时间空间局部性</li>
</ul>
</li>
</ul>
</li>
<li>替换算法

<ul>
<li>最近最少使用

<ul>
<li>回退状态指针

<ul>
<li>在删除某个翻译块后，和其相关的翻译块(链接关系)都需要更新状态</li>
</ul>
</li>
<li>难于维护，开销大</li>
</ul>
</li>
<li>满时清除

<ul>
<li>重复翻译浪费</li>
<li>丢失了部分profiling信息</li>
</ul>
</li>
<li>抢先清除

<ul>
<li>外部监控，定时处理</li>
</ul>
</li>
<li>细粒度FIFO

<ul>
<li>管理简单</li>
<li>仍然需要回退指针</li>
</ul>
</li>
<li>粗粒度FIFO

<ul>
<li>完全清楚是该方法的退化实现</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>系统环境

<ul>
<li>尽量透明

<ul>
<li>客户机限制最小化</li>
<li>客户机和主机可互操作</li>
</ul>
</li>
<li>主要是运行程序的加载器

<ul>
<li>源主机加载目标机DLL

<ul>
<li>尽量使加载过程由目标机统一完成</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<h2 id="tocAnchor-1-1-4">动态二进制优化</h2>

<ul>
<li>框架

<ul>
<li>基于基本块优化</li>
<li>可以分阶段不同程度优化</li>
</ul>
</li>
<li>动态程序的行为

<ul>
<li>一般程序的表现状况，统计结果</li>
<li>动态控制流是高度可预测的</li>
<li>容易出现双峰分支</li>
<li>大部分分支的判定结果与上次相同</li>
<li>向后的分支(多半是loop)通常是满足的</li>
<li>间接跳转的可预测性

<ul>
<li>向单一目标20%</li>
</ul>
</li>
<li>数据值的可预测性

<ul>
<li>大约20%与总是产生相同值的静态指令相关联</li>
</ul>
</li>
</ul>
</li>
<li>剖析(profiling)

<ul>
<li>意义

<ul>
<li>有选择的优化</li>
<li>利用有限的资源做出尽量最优的优化方案</li>
</ul>
</li>
<li>类型

<ul>
<li>执行频度--热点

<ul>
<li>基本块剖析</li>
</ul>
</li>
<li>基于控制流

<ul>
<li>块的边剖析</li>
<li>路径剖析

<ul>
<li>代价较大</li>
<li>利用边剖析结果基本可以获得较好的路径结果</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>收集方法

<ul>
<li>插桩

<ul>
<li>在跳转等特殊逻辑处放入统计代码</li>
<li>多处于解释处理阶段</li>
</ul>
</li>
<li>采样

<ul>
<li>多作用于翻译后的二进制码</li>
</ul>
</li>
</ul>
</li>
<li>解释期间的剖析

<ul>
<li>管理结构

<ul>
<li>分支PC散列</li>
</ul>
</li>
<li>剖析器衰减</li>
<li>边剖析的问题

<ul>
<li>数据量大</li>
<li>采用局部性原理</li>
</ul>
</li>
</ul>
</li>
<li>剖析翻译后的代码

<ul>
<li>插桩效率损失严重</li>
</ul>
</li>
<li>开销

<ul>
<li>性能

<ul>
<li>缩小插桩点</li>
</ul>
</li>
<li>空间</li>
</ul>
</li>
</ul>
</li>
<li>优化翻译块

<ul>
<li>提高局部性

<ul>
<li>空间

<ul>
<li>过程内联</li>
<li>代码重排</li>
</ul>
</li>
<li>时间</li>
</ul>
</li>
<li>分析单元

<ul>
<li>踪迹</li>
<li>超块

<ul>
<li>起始点

<ul>
<li>频繁程度</li>
<li>启发门限</li>
</ul>
</li>
<li>持续

<ul>
<li>结点信息＆边信息</li>
<li>最常使用</li>
<li>最近使用</li>
</ul>
</li>
<li>终止点

<ul>
<li>到达一个超级块</li>
<li>超块达到最大容量</li>
<li>不再有达到候选门限的候选基本块</li>
<li>到达一个间接跳转/方法调用</li>
</ul>
</li>
</ul>
</li>
<li>树簇

<ul>
<li>泛化的超块</li>
<li>适合分支跳转各分支概率持平</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>优化框架

<ul>
<li>总的原则是应该使用快速、低开销的优化来收集那些“可轻松实现的目标”</li>
<li>方法

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcycBiL4/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcycBiL4/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CcycB3n2/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcycB3n2/medish.jpg" /></li>
</ul>
</li>
<li>兼容性

<ul>
<li>陷阱</li>
<li>内存</li>
<li>寄存器</li>
</ul>
</li>
</ul>
</li>
<li>代码重排

<ul>
<li>基本指令重排

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcycADFb/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcycADFb/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CcyczZ27/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcyczZ27/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/Ccyczqav/medish.jpg" alt="http://pic.yupoo.com/qianjigui/Ccyczqav/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/Ccycz2bn/medish.jpg" alt="http://pic.yupoo.com/qianjigui/Ccycz2bn/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CcycAvM7/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcycAvM7/medish.jpg" /></li>
</ul>
</li>
<li>调度算法

<ul>
<li><ol>
<li>翻译到单指令形式</li>
</ol>
</li>
<li><ol>
<li>形成寄存器映射</li>
</ol>
</li>
<li><ol>
<li>重排代码</li>
</ol>
</li>
<li><ol>
<li>确定检查点</li>
</ol>
</li>
<li><ol>
<li>分配寄存器</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li>代码优化

<ul>
<li>基本

<ul>
<li>常量传播</li>
<li>常量折叠</li>
<li>代码下沉</li>
<li>复写传播</li>
<li>冗余分支消除</li>
<li>强度削除</li>
<li>无用赋值消除</li>
<li>循环不定式外提</li>
</ul>
</li>
<li>兼容性问题

<ul>
<li>陷阱安全</li>
</ul>
</li>
<li>超块间优化

<ul>
<li>链接</li>
<li>赋值移除</li>
</ul>
</li>
</ul>
</li>
<li>特定指令集优化</li>
</ul>


<h2 id="tocAnchor-1-1-5">高级语言虚拟机</h2>

<ul>
<li>结构

<ul>
<li>特点

<ul>
<li>安全和保护

<ul>
<li>数据访问权限</li>
<li>静态＆动态检查</li>
</ul>
</li>
<li>健壮性

<ul>
<li>GC</li>
</ul>
</li>
<li>网络</li>
<li>性能

<ul>
<li>Interp</li>
<li>JIT</li>
<li>AOT</li>
</ul>
</li>
</ul>
</li>
<li>Modules

<ul>
<li>VM

<ul>
<li>数据

<ul>
<li>类型

<ul>
<li>Primitive</li>
<li>Reference</li>
<li>Object</li>
<li>Array</li>
</ul>
</li>
<li>存储

<ul>
<li>Stack</li>
<li>Heap</li>
<li>全局内存</li>
<li>常量池</li>
<li>层次

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcyuP9pa/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcyuP9pa/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ISA指令集

<ul>
<li>Format</li>
<li>MOV</li>
<li>Cast</li>
<li>if/loop</li>
<li>Stack-opt</li>
</ul>
</li>
<li>Exception&amp;Error</li>
<li>ClassFileFormat

<ul>
<li>class</li>
<li>dex</li>
</ul>
</li>
<li>JNI</li>
</ul>
</li>
<li>APIs

<ul>
<li>Platforms</li>
<li>Serializes</li>
<li>Reflect</li>
<li>Thread</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>实现

<ul>
<li>结构

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYoNH5/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYoNH5/medish.jpg" /></li>
</ul>
</li>
<li>动态类加载

<ul>
<li>用于统一字节码</li>
<li>静态安全检查</li>
<li>验证完整性</li>
</ul>
</li>
<li>实现安全

<ul>
<li>沙盒

<ul>
<li>保护远程文件

<ul>
<li>远程操作系统控制</li>
</ul>
</li>
<li>本地文件受运行的Java程序保护

<ul>
<li>安全按理器实现</li>
</ul>
</li>
<li>JVM代码受运行的Java程序保护

<ul>
<li>静态＆动态检查</li>
</ul>
</li>
</ul>
</li>
<li>进程内保护

<ul>
<li>静态检查

<ul>
<li>元数据</li>
</ul>
</li>
<li>动态检查

<ul>
<li>NULL-Check</li>
<li>Array-Range-Check</li>
<li>Type-Cast-Check</li>
</ul>
</li>
</ul>
</li>
<li>安全强制执行

<ul>
<li>API</li>
</ul>
</li>
<li>增强的安全模型

<ul>
<li>身份</li>
<li>签名

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYtdh1/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYtdh1/medish.jpg" /></li>
</ul>
</li>
<li>利用调用栈做分析

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYENvY/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYENvY/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>垃圾收集

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYtokN/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYtokN/medish.jpg" /></li>
</ul>
</li>
<li>JNI

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYstmG/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYstmG/medish.jpg" /></li>
</ul>
</li>
<li>仿真

<ul>
<li>Interp</li>
<li>JIT

<ul>
<li>优化方法

<ul>
<li>代码重排</li>
<li>方法内联</li>
<li>VirtualMethodInvoke

<ul>
<li>Polymorphic Inline Caching(PIC)

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYEka1/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYEka1/medish.jpg" /></li>
</ul>
</li>
<li>守护指令

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYQjf0/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYQjf0/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>多版本和专门化

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYFHc2/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYFHc2/medish.jpg" /></li>
</ul>
</li>
<li>栈替换

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYIV5g/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYIV5g/medish.jpg" /></li>
</ul>
</li>
<li>堆分配对象

<ul>
<li>标量替换

<ul>
<li>逃逸分析</li>
</ul>
</li>
<li>对象域排列

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYDAGo/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYDAGo/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>低级别

<ul>
<li>Remove

<ul>
<li>NULL-Check</li>
<li>Range-Check</li>
</ul>
</li>
<li>循环剥离

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CcAYzvb7/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CcAYzvb7/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Profiling</li>
</ul>
</li>
</ul>
</li>
</ul>


<h2 id="tocAnchor-1-1-6">协同设计虚拟机</h2>

<ul>
<li>Structure

<ul>
<li>通过结合使用专用硬件和软件协同实现VMM</li>
<li><img src="http://pic.yupoo.com/qianjigui/CeGFosAw/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGFosAw/medish.jpg" /></li>
</ul>
</li>
<li>寄存器和存储器

<ul>
<li>映射

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeGFkd7j/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGFkd7j/medish.jpg" /></li>
</ul>
</li>
<li>VMM部分隐藏

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeGFh4If/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGFh4If/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>自修改和自引用代码

<ul>
<li>TLB</li>
<li><img src="http://pic.yupoo.com/qianjigui/CeGFmgFA/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGFmgFA/medish.jpg" /></li>
</ul>
</li>
<li>代码cache支持

<ul>
<li>跳转TLB(JTLB)

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeGFefHN/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGFefHN/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CeGF8NrK/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGF8NrK/medish.jpg" /></li>
</ul>
</li>
<li>双地址的返回地址栈

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeGFnBbX/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGFnBbX/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>实现精确陷阱

<ul>
<li>检查点硬件支持

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeGFbe1C/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGFbe1C/medish.jpg" /></li>
</ul>
</li>
<li>页错误兼容

<ul>
<li>积极页错误检测

<ul>
<li>LoopCheckAndReflesh</li>
</ul>
</li>
<li>懒惰页错误检测

<ul>
<li>CodeCacheUsedReflesh</li>
</ul>
</li>
<li><img src="http://pic.yupoo.com/qianjigui/CeGFd4qE/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGFd4qE/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>IO

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeGFiabB/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGFiabB/medish.jpg" /></li>
</ul>
</li>
</ul>


<h2 id="tocAnchor-1-1-7">系统虚拟机</h2>

<ul>
<li>应用

<ul>
<li>实现多道程序设计</li>
<li>多个安全环境</li>
<li>管理应用环境</li>
<li>混合操作系统环境</li>
<li>遗留的应用程序</li>
<li>跨平台应用开发</li>
<li>新系统过渡</li>
<li>系统软件开发</li>
<li>操作系统培训</li>
<li>客户帮助支持</li>
<li>操作系统分析</li>
<li>事件监控</li>
<li>系统封装</li>
</ul>
</li>
<li>关键概念

<ul>
<li>外观

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeGWMr2z/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGWMr2z/medish.jpg" /></li>
</ul>
</li>
<li>状态管理

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeGWKs3X/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGWKs3X/medish.jpg" /></li>
</ul>
</li>
<li>资源控制

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeGWG36A/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGWG36A/medish.jpg" /></li>
</ul>
</li>
<li>本地虚拟机和宿主虚拟机

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeGWO13S/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeGWO13S/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>资源虚拟化

<ul>
<li>CPU</li>
<li>Mem</li>
<li>IO</li>
</ul>
</li>
<li>性能提升

<ul>
<li>下降原因

<ul>
<li>建立</li>
<li>仿真</li>
<li>中断处理</li>
<li>状态保存</li>
<li>记录</li>
<li>时间延长</li>
</ul>
</li>
<li>VMM辅助手段

<ul>
<li>ContextSwitchByHardware</li>
<li>特权指令译码ByHardware</li>
<li>虚拟间隔计时器</li>
<li>扩展指令集</li>
</ul>
</li>
<li>客户系统的性能提升

<ul>
<li>不分页模式</li>
<li>伪缺页处理</li>
<li>假脱机文件</li>
<li>VMM间通信</li>
</ul>
</li>
<li>专用系统

<ul>
<li>虚实相等虚拟机</li>
<li>旁路影像页表辅助</li>
<li>优先机辅助</li>
<li>段共享</li>
</ul>
</li>
</ul>
</li>
</ul>


<h2 id="tocAnchor-1-1-8">多处理器虚拟化</h2>

<ul>
<li>目的

<ul>
<li>工作负载合并</li>
<li>SMP</li>
<li>系统移植</li>
<li>减少系统停机时间</li>
<li>异构系统</li>
<li>提高系统利用率</li>
<li>多时区需求</li>
<li>故障隔离</li>
</ul>
</li>
<li>划分

<ul>
<li>物理

<ul>
<li>好处

<ul>
<li>故障隔离</li>
<li>安全隔离</li>
<li>满足系统级需求</li>
</ul>
</li>
</ul>
</li>
<li>逻辑

<ul>
<li>分配

<ul>
<li>CPU</li>
<li>Storage</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<h2 id="tocAnchor-1-1-9">实际机器</h2>

<ul>
<li>Hardware

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeJsprNf/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeJsprNf/medish.jpg" /></li>
<li>CPU

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeJsrljX/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeJsrljX/medish.jpg" /></li>
</ul>
</li>
<li>Storage

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeJsxZtb/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeJsxZtb/medish.jpg" /></li>
<li><img src="http://pic.yupoo.com/qianjigui/CeJsvSNl/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeJsvSNl/medish.jpg" /></li>
</ul>
</li>
<li>IO

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeJstqED/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeJstqED/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>ISA

<ul>
<li>用户

<ul>
<li>运算

<ul>
<li>Register

<ul>
<li>通用</li>
<li>特殊</li>
<li>专用</li>
</ul>
</li>
<li>Storage</li>
</ul>
</li>
</ul>
</li>
<li>系统

<ul>
<li>资源管理

<ul>
<li>特权级别

<ul>
<li>System</li>
<li>User</li>
</ul>
</li>
<li>SystemRegister

<ul>
<li>SystemTimer</li>
<li>Interupt&amp;Halt</li>
<li>MarkInterupt</li>
<li>AddressTransferPointer</li>
</ul>
</li>
<li>CPU

<ul>
<li>系统调用</li>
<li>返回指令</li>
<li>可产生中断的时间间隔计时器</li>
</ul>
</li>
<li>Storage

<ul>
<li>Structure

<ul>
<li>Fragment大小任意</li>
<li>Page大小固定</li>
</ul>
</li>
<li>PageTable

<ul>
<li>TLB</li>
<li>prot</li>
<li><img src="http://pic.yupoo.com/qianjigui/CeJsxG80/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeJsxG80/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>IO

<ul>
<li>IOStorageMapping</li>
</ul>
</li>
<li>Interupt</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>OS

<ul>
<li>Structure

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeJsvf75/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeJsvf75/medish.jpg" /></li>
<li>CPUManagement</li>
<li>StorageManagement</li>
<li>IOManagement

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeJsuM6X/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeJsuM6X/medish.jpg" /></li>
</ul>
</li>
</ul>
</li>
<li>Interface

<ul>
<li>Process

<ul>
<li>fork</li>
<li>exec</li>
<li>exit</li>
<li>wait</li>
<li>sleep</li>
<li>wakeup</li>
<li>setpriority</li>
<li>getrusage</li>
</ul>
</li>
<li>Storage

<ul>
<li>sbrk</li>
<li>malloc</li>
<li>free</li>
<li>mprotect</li>
<li>shmget</li>
</ul>
</li>
<li>IO

<ul>
<li><img src="http://pic.yupoo.com/qianjigui/CeJssy1x/medish.jpg" alt="http://pic.yupoo.com/qianjigui/CeJssy1x/medish.jpg" /></li>
<li>read</li>
<li>open</li>
<li>close</li>
<li>write</li>
</ul>
</li>
<li>Signal

<ul>
<li>sigvec</li>
<li>kill</li>
<li>sigblock</li>
<li>sigsetmask</li>
<li>sigreturn</li>
</ul>
</li>
</ul>
</li>
<li>Init</li>
</ul>
</li>
<li>MultiCPUs

<ul>
<li>集群计算</li>
<li>共享存储多处理器</li>
</ul>
</li>
</ul>


<h2 id="tocAnchor-1-1-10">tags: VM JVM</h2>

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/it/technical/language/java/2012/08/06/Annotation" title="Java 标注">&larr; 老的一篇</a></li>
      
        <li><a href="/archive.html">归档列表</a></li>
      
        <li class="next"><a href="/it/technical/vm/2012/08/08/index" title="虚拟机技术相关概要">新的一篇 &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  
<!-- Duoshuo Comment start -->
<div class="ds-thread" data-thread-key="/it/technical/vm/2012/08/08/VirtualMachines" data-title="Virtual Machines" data-url="http://www.5wpc.info/it/technical/vm/2012/08/08/VirtualMachines/"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"qianjigui"};
(function() {
 var ds = document.createElement('script');
 ds.type = 'text/javascript';ds.async = true;
 ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
 ds.charset = 'UTF-8';
 (document.getElementsByTagName('head')[0]
  || document.getElementsByTagName('body')[0]).appendChild(ds);
 })();
</script>
<!-- Duoshuo Comment end -->





  </div>
  
  <div class="span4">
    <div id="toc-container"><table class="toc" id="toc"><tbody><tr><td><div id="toctitle"><h2>文章目录</h2></div><ul><li class="toc_level-1 toc_section-1"><a href="#tocAnchor-1-1"><span class="tocnumber">1</span> <span class="toctext">Virtual Machines</span></a><ul><li class="toc_level-2 toc_section-2"><a href="#tocAnchor-1-1-1"><span class="tocnumber">1.1</span> <span class="toctext">导论</span></a></li><li class="toc_level-2 toc_section-3"><a href="#tocAnchor-1-1-2"><span class="tocnumber">1.2</span> <span class="toctext">仿真：解释和二进制翻译</span></a></li><li class="toc_level-2 toc_section-4"><a href="#tocAnchor-1-1-3"><span class="tocnumber">1.3</span> <span class="toctext">进程虚拟机</span></a></li><li class="toc_level-2 toc_section-5"><a href="#tocAnchor-1-1-4"><span class="tocnumber">1.4</span> <span class="toctext">动态二进制优化</span></a></li><li class="toc_level-2 toc_section-6"><a href="#tocAnchor-1-1-5"><span class="tocnumber">1.5</span> <span class="toctext">高级语言虚拟机</span></a></li><li class="toc_level-2 toc_section-7"><a href="#tocAnchor-1-1-6"><span class="tocnumber">1.6</span> <span class="toctext">协同设计虚拟机</span></a></li><li class="toc_level-2 toc_section-8"><a href="#tocAnchor-1-1-7"><span class="tocnumber">1.7</span> <span class="toctext">系统虚拟机</span></a></li><li class="toc_level-2 toc_section-9"><a href="#tocAnchor-1-1-8"><span class="tocnumber">1.8</span> <span class="toctext">多处理器虚拟化</span></a></li><li class="toc_level-2 toc_section-10"><a href="#tocAnchor-1-1-9"><span class="tocnumber">1.9</span> <span class="toctext">实际机器</span></a></li><li class="toc_level-2 toc_section-11"><a href="#tocAnchor-1-1-10"><span class="tocnumber">1.10</span> <span class="toctext">tags: VM JVM</span></a></li></ul></li></ul></td></tr></tbody></table></div>
    <h4>创建@</h4>
    <div class="date"><span>2012-08-08</span></div>
    
        <h4>最后修改@</h4>
        <div class="date"><span>2013-05-04</span></div>
    

  
    <h4>标签/Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#VM-ref">VM <span>5</span></a></li>
     
    	<li><a href="/tags.html#JVM-ref">JVM <span>3</span></a></li>
    
  



    </ul>
  

  
    <h4>相同类目/Categories</h4>
    <ul>
    
    
    


  
    
      
      	
      	<li><a href="/it/technical/vm/2013/09/06/VMGroupDiscuss">VM-Group-Discuss</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/it/technical/vm/2012/08/18/GC">垃圾收集技术</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/it/technical/vm/2012/08/08/index">虚拟机技术相关概要</a></li>
      	
      
    
  
    
      
      	
      	<li class="active"><a href="/it/technical/vm/2012/08/08/VirtualMachines" class="active">Virtual Machines</a></li>
      	
      
    
  




    </ul>
  
  </div>
</div>


      </div>

      <footer>
    <p>&copy; 王鹏程(WPC) 2010-2014
    with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
    and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
    <p>
    声明：文章版权属于王鹏程(WPC)，受法律保护。没有作者书面许可不得转载。若作者同意转载，必须以超链接形式标明文章原始出处和作者。
    </p>
    </p>
</footer>


    </div> <!-- /container -->

    
  </body>
</html>

